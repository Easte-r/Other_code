<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>星际大战</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
	</style>
</head>
<body>
	<canvas id="canvas"></canvas>
	<script>
		var canvas = document.getElementById('canvas')
		var ctx = canvas.getContext('2d')
		var width = window.innerWidth
		var height = window.innerHeight
		canvas.width = width
		canvas.height= height
		var R = 65
		var rr = 5
		var v = 5
		var x = width / 2 //canvas中心的坐标
		var y = height/ 2
		var zidan = []
		var zidan0
		var startXX
		var startYY
		var endXX
		var endYY
		var num=4
		var xx,yy, //鼠标在页面中的坐标
			xxx,yyy //炮口在页面中的坐标
		(function start(){
			window.requestAnimationFrame(start)
			// console.log("haha")
			if (num == 4) {
				init()
				num = 0
			}
			num++
			draw()
			test()
			change()

		})()
		function init(){//制造子弹
			startXX = xxx
			startYY = yyy
			endXX = (xxx - x) * (R + rr) / R + x
			endYY = (yyy - y) * (R + rr) / R + y
			zidan0 = {startX: startXX,startY: startYY,endX:endXX,endY:endYY}
			zidan.push(zidan0)
		}
		function draw(){
			ctx.clearRect(0,0,width,height)

			ctx.save() //炮台
			ctx.beginPath()
			ctx.moveTo(x,y)
			ctx.lineTo(xxx,yyy)
			ctx.strokeStyle = '#000'
			ctx.stroke()
			ctx.restore()

			for (var i = 0; i < zidan.length; i++) {
				ctx.save()
				ctx.beginPath()
				ctx.moveTo(zidan[i].startX,zidan[i].startY)
				ctx.lineTo(zidan[i].endX,zidan[i].endY)
				ctx.lineWidth = 2
				ctx.strokeStyle = '#000'
				ctx.stroke()
				ctx.restore()
			}
		}
		function test(){
			for (var i = 0; i < zidan.length; i++) {
				if (zidan[i].startX > width || zidan[i].startX<0||zidan[i].startY > height|| zidan[i].startY <0) {
					zidan.splice(i,1)
					i--
				}
			}
			console.log(zidan.length)
		}
		function change(){//改变子弹
			var b 
			for (var i = 0; i < zidan.length; i++) {
				b = Math.sqrt((zidan[i].endX - x)*(zidan[i].endX - x) + (zidan[i].endY - y)*(zidan[i].endY - y))
				zidan[i].startX = zidan[i].endX
				zidan[i].startY = zidan[i].endY
				zidan[i].endX   = (zidan[i].startX - x) * (b + rr) / b + x
				zidan[i].endY   = (zidan[i].startY - y) * (b + rr) / b + y
			}
		}
		function Move(event){
			xx = event.pageX
			yy = event.pageY
			a = Math.sqrt((xx - x)*(xx - x) + (yy - y)*(yy - y))
			xxx = (xx - x) * R / a + x
			yyy = (yy - y) * R / a + y
		}
		window.addEventListener('mousemove',Move,false)
	</script>
</body>
</html>